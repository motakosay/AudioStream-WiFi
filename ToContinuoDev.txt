//server.py

import pyaudio
import socket
import threading
import time

# üéöÔ∏è Audio settings
CHUNK = 500 #chunks basic = 1024
FORMAT = pyaudio.paInt16
CHANNELS = 1  # Change to 1 for mono #basic 2
RATE = 48000
PORT = 8765  # Must match Android app

# üéõÔ∏è Initialize PyAudio
p = pyaudio.PyAudio()

# üîç Find VB-Cable input device
def find_vb_cable():
    for i in range(p.get_device_count()):
        dev = p.get_device_info_by_index(i)
        if "CABLE Input" in dev["name"] or "VB-Audio" in dev["name"]:
            print(f"üéôÔ∏è Ritual begins with: {dev['name']}")
            return i
    raise RuntimeError("‚ùå VB-Cable not found! Ensure it's installed and set as default playback device.")

input_index = find_vb_cable()

# üé§ Open audio stream
stream = p.open(format=FORMAT,
                channels=CHANNELS,
                rate=RATE,
                input=True,
                input_device_index=input_index,
                frames_per_buffer=CHUNK)

clients = []

# üßµ Handle each client
def client_handler(conn, addr):
    print(f"üîó Connected: {addr}")
    try:
        while True:
            data = stream.read(CHUNK, exception_on_overflow=False)
            conn.sendall(data)
    except Exception as e:
        print(f"‚ö° Disconnected: {addr} ‚Äî {type(e).__name__}: {e}")
    finally:
        try:
            conn.close()
            clients.remove(conn)
        except ValueError:
            pass

# üåê TCP server setup
server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server.bind(("0.0.0.0", PORT))
server.listen(5)
print(f"üåÄ Listening on port {PORT} ‚Äî awaiting sonic pilgrims...")

# üßò Main loop
try:
    while True:
        conn, addr = server.accept()
        clients.append(conn)
        threading.Thread(target=client_handler, args=(conn, addr), daemon=True).start()
except KeyboardInterrupt:
    print("üïäÔ∏è Graceful shutdown initiated...")
finally:
    server.close()
    stream.stop_stream()
    stream.close()
    p.terminate()
    print("üîö Audio stream closed.")

//AndroidManifest.xml

<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.example.audiostream">

    <uses-permission android:name="android.permission.INTERNET" />

    <application
        android:allowBackup="true"
        android:label="AudioStream"
        android:supportsRtl="true">
        <activity android:name=".MainActivity">
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>
    </application>
</manifest>

//MainActivity.java

package com.example.audiostream;

import android.app.Activity;
import android.media.AudioFormat;
import android.media.AudioManager;
import android.media.AudioTrack;
import android.os.Bundle;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;
import android.widget.TextView;

import java.io.InputStream;
import java.net.Socket;

public class MainActivity extends Activity {
    private TextView statusView;
    private AudioTrack audioTrack;
    private volatile boolean isStreaming = false;
    private Thread streamThread = null;
    private Socket socket = null;
    private String currentIp = "";

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        int layoutId = getResources().getIdentifier("activity_main", "layout", getPackageName());
        setContentView(layoutId);

        int ipInputId = getResources().getIdentifier("ipInput", "id", getPackageName());
        int connectBtnId = getResources().getIdentifier("connectBtn", "id", getPackageName());
        int stopBtnId = getResources().getIdentifier("stopBtn", "id", getPackageName());
        int statusViewId = getResources().getIdentifier("statusView", "id", getPackageName());

        final EditText ipInput = findViewById(ipInputId);
        Button connectBtn = findViewById(connectBtnId);
        Button stopBtn = findViewById(stopBtnId);
        statusView = findViewById(statusViewId);

        connectBtn.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                final String ip = ipInput.getText().toString().trim();
                if (!ip.isEmpty()) {
                    currentIp = ip;
                    startStreaming(ip);
                } else {
                    statusView.setText("Enter a valid IP!");
                }
            }
        });

        stopBtn.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                stopStreaming();
            }
        });
    }

    private void startStreaming(final String ip) {
        if (isStreaming) return;
        isStreaming = true;

        streamThread = new Thread(new Runnable() {
            @Override
            public void run() {
                while (isStreaming) {
                    try {
                        runOnUiThread(new Runnable() {
                            @Override
                            public void run() {
                                statusView.setText("Connecting to " + ip + "...");
                            }
                        });

                        socket = new Socket(ip, 8765);
                        InputStream in = socket.getInputStream();

                        int minBuf = AudioTrack.getMinBufferSize(
                                48000,
                                AudioFormat.CHANNEL_OUT_STEREO,
                                AudioFormat.ENCODING_PCM_16BIT
                        );

                        audioTrack = new AudioTrack(
                                AudioManager.STREAM_MUSIC,
                                48000,
                                AudioFormat.CHANNEL_OUT_STEREO,
                                AudioFormat.ENCODING_PCM_16BIT,
                                minBuf,
                                AudioTrack.MODE_STREAM
                        );
                        audioTrack.play();

                        runOnUiThread(new Runnable() {
                            @Override
                            public void run() {
                                statusView.setText("Connected :) !");
                            }
                        });

                        byte[] buffer = new byte[4096];
                        int read;
                        while (isStreaming && (read = in.read(buffer)) != -1) {
                            audioTrack.write(buffer, 0, read);
                        }

                    } catch (Exception e) {
                        runOnUiThread(new Runnable() {
                            @Override
                            public void run() {
                                statusView.setText("Connection lost, retrying...");
                            }
                        });
                        cleanupAudioOnly(); // don't stop the loop, just reset audio
                        sleep(2000); // wait before retry
                    } finally {
                        cleanupSocketOnly();
                    }
                }
                cleanup(); // final cleanup when stopped

                runOnUiThread(new Runnable() {
                    @Override
                    public void run() {
                        statusView.setText("Stopped");
                    }
                });
            }
        });

        streamThread.start();
    }

    private void stopStreaming() {
        isStreaming = false;
        runOnUiThread(new Runnable() {
            @Override
            public void run() {
                statusView.setText("Stopping...");
            }
        });
        cleanup();
    }

    private void cleanupAudioOnly() {
        if (audioTrack != null) {
            try {
                audioTrack.stop();
                audioTrack.release();
            } catch (Exception ignored) {}
            audioTrack = null;
        }
    }

    private void cleanupSocketOnly() {
        if (socket != null) {
            try {
                socket.close();
            } catch (Exception ignored) {}
            socket = null;
        }
    }

    private void cleanup() {
        cleanupAudioOnly();
        cleanupSocketOnly();
    }

    private void sleep(long ms) {
        try {
            Thread.sleep(ms);
        } catch (InterruptedException ignored) {}
    }

    @Override
    protected void onDestroy() {
        super.onDestroy();
        stopStreaming();
    }
}

//activity_main.xml

<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:orientation="vertical"
    android:padding="16dp"
    android:layout_width="match_parent"
    android:layout_height="match_parent">

    <EditText
        android:id="@+id/ipInput"
        android:hint="Enter PC IP"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:inputType="text"/>

    <Button
        android:id="@+id/connectBtn"
        android:text="Connect"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"/>

    <Button
        android:id="@+id/stopBtn"
        android:text="Stop"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="12dp" />

    <TextView
        android:id="@+id/statusView"
        android:text="Status: Disconnected"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:paddingTop="16dp"/>
</LinearLayout>

//strings.xml


<resources>
    <string name="app_name">AudioStream</string>
</resources>
