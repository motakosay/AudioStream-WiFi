//server.py

import pyaudio
import socket
import threading

# üéöÔ∏è Audio settings
CHUNK = 1024
FORMAT = pyaudio.paInt16
RATE = 48000
PORT = 8765

p = pyaudio.PyAudio()

# üîç Find VB-Cable input device
def find_vb_cable():
    for i in range(p.get_device_count()):
        dev = p.get_device_info_by_index(i)
        if "CABLE Input" in dev["name"] or "VB-Audio" in dev["name"]:
            print(f"üéôÔ∏è Ritual begins with: {dev['name']}")
            return i
    raise RuntimeError("‚ùå VB-Cable not found! Ensure it's installed and set as default playback device.")

input_index = find_vb_cable()

clients = []

# üßµ Handle each client
def client_handler(conn, addr):
    print(f"üîó Connected: {addr}")
    try:
        # First message from client = channel request
        handshake = conn.recv(16).decode().strip()
        if handshake.startswith("CHANNELS:"):
            channels = int(handshake.split(":")[1])
        else:
            channels = 1  # default mono

        print(f"üéõÔ∏è Client {addr} requested {channels} channel(s)")

        # Open audio stream with requested channels
        stream = p.open(format=FORMAT,
                        channels=channels,
                        rate=RATE,
                        input=True,
                        input_device_index=input_index,
                        frames_per_buffer=CHUNK)

        while True:
            data = stream.read(CHUNK, exception_on_overflow=False)
            conn.sendall(data)

    except Exception as e:
        print(f"‚ö° Disconnected: {addr} ‚Äî {type(e).__name__}: {e}")
    finally:
        try:
            conn.close()
            clients.remove(conn)
        except ValueError:
            pass
        try:
            stream.stop_stream()
            stream.close()
        except Exception:
            pass

# üåê TCP server setup
server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server.bind(("0.0.0.0", PORT))
server.listen(5)
print(f"üåÄ Listening on port {PORT} ‚Äî awaiting sonic pilgrims...")

# üßò Main loop
try:
    while True:
        conn, addr = server.accept()
        clients.append(conn)
        threading.Thread(target=client_handler, args=(conn, addr), daemon=True).start()
except KeyboardInterrupt:
    print("üïäÔ∏è Graceful shutdown initiated...")
finally:
    server.close()
    p.terminate()
    print("üîö Audio stream closed.")


//AndroidMainfest.xml

<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.example.audiostream">

    <!-- üåê Network permissions -->
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
    <uses-permission android:name="android.permission.CHANGE_WIFI_STATE" />

    <!-- üìç Location permission required for Wi-Fi scanning on Android 10+ -->
    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />

    <!-- üîä Bluetooth permissions -->
    <uses-permission android:name="android.permission.BLUETOOTH" />
    <uses-permission android:name="android.permission.BLUETOOTH_ADMIN" />

    <application
        android:allowBackup="true"
        android:label="AudioStream"
        android:supportsRtl="true">
        <activity android:name=".MainActivity">
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>
    </application>
</manifest>

//MainActivity.java

package com.example.audiostream;

import android.app.Activity;
import android.bluetooth.BluetoothAdapter;
import android.content.Context;
import android.media.AudioFormat;
import android.media.AudioManager;
import android.media.AudioTrack;
import android.net.wifi.WifiManager;
import android.os.Bundle;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;
import android.widget.RadioButton;
import android.widget.TextView;

import java.io.InputStream;
import java.io.OutputStream;
import java.net.InetSocketAddress;
import java.net.Socket;

public class MainActivity extends Activity {
    private TextView statusView;
    private AudioTrack audioTrack;
    private volatile boolean isStreaming = false;
    private Thread streamThread = null;
    private Socket socket = null;
    private String currentIp = "";
    private int currentChannelConfig = AudioFormat.CHANNEL_OUT_MONO; // default mono

    private WifiManager wifiManager;
    private BluetoothAdapter bluetoothAdapter;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        int layoutId = getResources().getIdentifier("activity_main", "layout", getPackageName());
        setContentView(layoutId);

        int ipInputId = getResources().getIdentifier("ipInput", "id", getPackageName());
        int connectBtnId = getResources().getIdentifier("connectBtn", "id", getPackageName());
        int stopBtnId = getResources().getIdentifier("stopBtn", "id", getPackageName());
        int statusViewId = getResources().getIdentifier("statusView", "id", getPackageName());
        int monoBtnId = getResources().getIdentifier("monoBtn", "id", getPackageName());
        int stereoBtnId = getResources().getIdentifier("stereoBtn", "id", getPackageName());

        final EditText ipInput = findViewById(ipInputId);
        Button connectBtn = findViewById(connectBtnId);
        Button stopBtn = findViewById(stopBtnId);
        statusView = findViewById(statusViewId);
        final RadioButton monoBtn = findViewById(monoBtnId);
        final RadioButton stereoBtn = findViewById(stereoBtnId);

        // Default selection
        monoBtn.setChecked(true);

        wifiManager = (WifiManager) getApplicationContext().getSystemService(Context.WIFI_SERVICE);
        bluetoothAdapter = BluetoothAdapter.getDefaultAdapter();

        connectBtn.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                ensureConnectivity();

                new Thread(new Runnable() {
                    @Override
                    public void run() {
                        String ip = findServerIp();
                        runOnUiThread(new Runnable() {
                            @Override
                            public void run() {
                                if (ip != null) {
                                    currentIp = ip;
                                    if (monoBtn.isChecked()) {
                                        currentChannelConfig = AudioFormat.CHANNEL_OUT_MONO;
                                    } else if (stereoBtn.isChecked()) {
                                        currentChannelConfig = AudioFormat.CHANNEL_OUT_STEREO;
                                    }
                                    statusView.setText("Found server at " + ip + " ‚Äî connecting...");
                                    startStreaming(ip);
                                } else {
                                    statusView.setText("Know IP of your Device then type it");
                                }
                            }
                        });
                    }
                }).start();
            }
        });

        stopBtn.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                stopStreaming();
            }
        });
    }

    private void ensureConnectivity() {
        if (!wifiManager.isWifiEnabled()) {
            wifiManager.setWifiEnabled(true);
        }
        if (bluetoothAdapter != null && !bluetoothAdapter.isEnabled()) {
            bluetoothAdapter.enable();
        }
    }

    private String findServerIp() {
        for (int i = 2; i < 255; i++) {
            String testIp = "192.168.1." + i;
            try (Socket testSocket = new Socket()) {
                testSocket.connect(new InetSocketAddress(testIp, 8765), 500);
                return testIp;
            } catch (Exception ignored) {}
        }
        return null;
    }

    private void startStreaming(final String ip) {
        if (isStreaming) return;
        isStreaming = true;

        streamThread = new Thread(new Runnable() {
            @Override
            public void run() {
                while (isStreaming) {
                    try {
                        runOnUiThread(new Runnable() {
                            @Override
                            public void run() {
                                statusView.setText("Connecting to " + ip + "...");
                            }
                        });

                        socket = new Socket(ip, 8765);

                        String handshake = "CHANNELS:" + (currentChannelConfig == AudioFormat.CHANNEL_OUT_MONO ? "1" : "2");
                        OutputStream out = socket.getOutputStream();
                        out.write(handshake.getBytes());
                        out.flush();

                        InputStream in = socket.getInputStream();

                        int minBuf = AudioTrack.getMinBufferSize(
                                48000,
                                currentChannelConfig,
                                AudioFormat.ENCODING_PCM_16BIT
                        );

                        audioTrack = new AudioTrack(
                                AudioManager.STREAM_MUSIC,
                                48000,
                                currentChannelConfig,
                                AudioFormat.ENCODING_PCM_16BIT,
                                minBuf,
                                AudioTrack.MODE_STREAM
                        );
                        audioTrack.play();

                        runOnUiThread(new Runnable() {
                            @Override
                            public void run() {
                                statusView.setText("Connected :) !");
                            }
                        });

                        byte[] buffer = new byte[minBuf];
                        int read;
                        while (isStreaming && (read = in.read(buffer)) != -1) {
                            int written = audioTrack.write(buffer, 0, read);
                            if (written < 0) {
                                resetAudioTrack();
                            }
                        }

                    } catch (Exception e) {
                        runOnUiThread(new Runnable() {
                            @Override
                            public void run() {
                                statusView.setText("Connection lost, retrying...");
                            }
                        });
                        cleanupAudioOnly();
                        sleep(2000);
                    } finally {
                        cleanupSocketOnly();
                    }
                }
                cleanup();
                runOnUiThread(new Runnable() {
                    @Override
                    public void run() {
                        statusView.setText("Stopped");
                    }
                });
            }
        });

        streamThread.start();
    }

    private void resetAudioTrack() {
        cleanupAudioOnly();
        int minBuf = AudioTrack.getMinBufferSize(
                48000,
                currentChannelConfig,
                AudioFormat.ENCODING_PCM_16BIT
        );
        audioTrack = new AudioTrack(
                AudioManager.STREAM_MUSIC,
                48000,
                currentChannelConfig,
                AudioFormat.ENCODING_PCM_16BIT,
                minBuf,
                AudioTrack.MODE_STREAM
        );
        audioTrack.play();
    }

    private void stopStreaming() {
        isStreaming = false;
        runOnUiThread(new Runnable() {
            @Override
            public void run() {
                statusView.setText("Stopping...");
            }
        });
        cleanup();
    }

    private void cleanupAudioOnly() {
        if (audioTrack != null) {
            try {
                audioTrack.stop();
                audioTrack.release();
            } catch (Exception ignored) {}
            audioTrack = null;
        }
    }

    private void cleanupSocketOnly() {
        if (socket != null) {
            try {
                socket.close();
            } catch (Exception ignored) {}
            socket = null;
        }
    }

    private void cleanup() {
        cleanupAudioOnly();
        cleanupSocketOnly();
    }

    private void sleep(long ms) {
        try {
            Thread.sleep(ms);
        } catch (InterruptedException ignored) {}
    }

    @Override
    protected void onDestroy() {
        super.onDestroy();
        stopStreaming();
    }
}

//activity_main.xml

<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:orientation="vertical"
    android:padding="16dp"
    android:layout_width="match_parent"
    android:layout_height="match_parent">

    <EditText
        android:id="@+id/ipInput"
        android:hint="Enter PC IP"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:inputType="text"/>

    <!-- Label for audio mode selection -->
    <TextView
        android:id="@+id/channelLabel"
        android:text="Select Audio Mode:"
        android:textStyle="bold"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:paddingTop="12dp"
        android:paddingBottom="4dp"/>

    <!-- Grouped Mono/Stereo selection -->
    <RadioGroup
        android:id="@+id/channelGroup"
        android:orientation="horizontal"
        android:layout_width="match_parent"
        android:layout_height="wrap_content">

        <RadioButton
            android:id="@+id/monoBtn"
            android:text="Mono"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:checked="true"/> <!-- ‚úÖ Default selection -->

        <RadioButton
            android:id="@+id/stereoBtn"
            android:text="Stereo"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_marginStart="24dp"/>
    </RadioGroup>

    <Button
        android:id="@+id/connectBtn"
        android:text="Connect"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="12dp"/>

    <Button
        android:id="@+id/stopBtn"
        android:text="Stop"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="12dp"/>

    <TextView
        android:id="@+id/statusView"
        android:text="Status: Disconnected"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:paddingTop="16dp"/>
</LinearLayout>

//strings.xml

<resources>
    <string name="app_name">AudioStream</string>
</resources>
